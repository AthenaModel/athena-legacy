# -*-Tcl-*-
#-----------------------------------------------------------------------
# TITLE:
#    010-scenario.test
#
# AUTHOR:
#    Will Duquette
#
# DESCRIPTION:
#    scenario(sim) tests.
#
#    This test suite tests the scenario(sim) mutators and queries
#
#    TBD: At present, it really only tests "scenario mutate reconcile".
#
#-----------------------------------------------------------------------

#-----------------------------------------------------------------------
# Test Suite
#
# The tests run in a namespace so as not to interfere with other
# test suites.

namespace eval ::athena_test::tests:: {
    #-------------------------------------------------------------------
    # Set up the test environment

    # Import tcltest(n)
    namespace import ::tcltest::*
    
    # Clean up after a test

    proc cleanup {} {
        # Clean up the test environment
        ted cleanup
    }

    #-------------------------------------------------------------------
    # mutate reconcile
    #
    # All we really need to test is that each mutate reconcile command
    # is called.
   

    test reconcile-1.1 {All entities are reconciled} -body {
        ted notifier bind ::rdb      <rel_fg>
        ted notifier bind ::rdb      <coop_fg>
        ted notifier bind ::rdb      <attroe_nfg>
        ted notifier bind ::rdb      <defroe_fg>
        ted notifier bind ::scenario <Reconcile>

        rdb monitor transaction {
            ted create BLUE USAID NB1 SHIA

            scenario mutate reconcile

            nbhood mutate delete NB1

            scenario mutate reconcile
        }

        ted notifier received
    } -cleanup {
        cleanup
    } -result {
        {::scenario <Reconcile>}
        {::scenario <Reconcile>}
        {::rdb <rel_fg> update {BLUE BLUE}}
        {::rdb <rel_fg> update {BLUE USAID}}
        {::rdb <rel_fg> update {BLUE SHIA}}
        {::rdb <rel_fg> update {USAID BLUE}}
        {::rdb <rel_fg> update {USAID USAID}}
        {::rdb <rel_fg> update {USAID SHIA}}
        {::rdb <rel_fg> update {SHIA BLUE}}
        {::rdb <rel_fg> update {SHIA USAID}}
        {::rdb <rel_fg> update {SHIA SHIA}}
        {::rdb <coop_fg> update {SHIA BLUE}}
        {::rdb <rel_fg> delete {BLUE SHIA}}
        {::rdb <rel_fg> delete {USAID SHIA}}
        {::rdb <rel_fg> delete {SHIA BLUE}}
        {::rdb <rel_fg> delete {SHIA USAID}}
        {::rdb <rel_fg> delete {SHIA SHIA}}
        {::rdb <coop_fg> delete {SHIA BLUE}}
    }


    test reconcile-1.2 {On undo: unreconcile} -body {
        ted create BLUE USAID NB1 SHIA

        scenario mutate reconcile

        nbhood mutate delete NB1
        frcgroup mutate delete BLUE

        set undo [scenario mutate reconcile]

        ted notifier bind ::rdb      <rel_fg>
        ted notifier bind ::rdb      <coop_fg>
        ted notifier bind ::rdb      <defroe_fg>
        ted notifier bind ::scenario <Reconcile>

        rdb monitor transaction {
            eval $undo
        }
        
        ted notifier received
    } -cleanup {
        cleanup
    } -result {
        {::rdb <rel_fg> update {BLUE BLUE}}
        {::rdb <rel_fg> update {BLUE USAID}}
        {::rdb <rel_fg> update {BLUE SHIA}}
        {::rdb <rel_fg> update {USAID BLUE}}
        {::rdb <rel_fg> update {USAID SHIA}}
        {::rdb <rel_fg> update {SHIA BLUE}}
        {::rdb <rel_fg> update {SHIA USAID}}
        {::rdb <rel_fg> update {SHIA SHIA}}
        {::rdb <coop_fg> update {SHIA BLUE}}
    }

    #-------------------------------------------------------------------
    # Cleanup

    cleanupTests
}

namespace delete ::athena_test::tests::






