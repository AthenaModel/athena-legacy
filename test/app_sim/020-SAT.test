# -*-Tcl-*-
#-----------------------------------------------------------------------
# TITLE:
#    020-SAT.test
#
# AUTHOR:
#    Will Duquette
#
# DESCRIPTION:
#    app_sim(1) SAT:* order tests.
#
#    This test suite tests the satisfaction-curve-related orders.
#
#-----------------------------------------------------------------------

#-----------------------------------------------------------------------
# Test Suite
#
# The tests run in a namespace so as not to interfere with other
# test suites.

namespace eval ::athena_test::tests:: {
    #-------------------------------------------------------------------
    # Set up the test environment

    # Import tcltest(n)
    namespace import ::tcltest::*

    proc setup {} {
        ted create NB1 SHIA SUNN NB1SHIA
        sat mutate reconcile
    }


    # Clean up after a test

    proc cleanup {} {
        ted cleanup
    }


    #-------------------------------------------------------------------
    # SAT:UPDATE

    test UPDATE-1.1 {required parms} -body {
        ted order -reject SAT:UPDATE {}
    } -result {
        n {required value}
        g {required value}
        c {required value}
    }
    

    test UPDATE-1.2 {invalid n, g, c} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE n NONESUCH1 g NONESUCH2 c NONESUCH3
    } -cleanup {
        cleanup
    } -result {
        n {Invalid neighborhood, should be one of: NB1}
        g {Invalid satisfaction group, should be one of: SHIA, SUNN}
        c {invalid value "NONESUCH3", should be one of: AUT, SFT, CUL, QOL, CAS}
    }


    test UPDATE-1.3 {undefined curve} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE n NB1 g SUNN c AUT
    } -cleanup {
        cleanup
    } -result {
        c {Satisfaction is not tracked for group SUNN's AUT in NB1.}
    }


    test UPDATE-1.4 {invalid sat0: symbol} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE n NB1 g SHIA c SFT sat0 NONESUCH
    } -cleanup {
        cleanup
    } -result {
        sat0 {invalid value "NONESUCH", should be a real number in range -100.0, 100.0, or one of: VS, S, A, D, VD}
    }


    test UPDATE-1.5 {} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE n NB1 g SHIA c SFT sat0 101.0
    } -cleanup {
        cleanup
    } -result {
        sat0 {invalid value "101.0", should be a real number in range -100.0, 100.0, or one of: VS, S, A, D, VD}
    }


    test UPDATE-1.6 {invalid saliency: symbol} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE n NB1 g SHIA c SFT saliency NONESUCH
    } -cleanup {
        cleanup
    } -result {
        saliency {invalid value "NONESUCH", should be a real number in range 0.0, 1.0, or one of: CR, VI, I, LI, UN, NG}
    }


    test UPDATE-1.7 {invalid saliency: out of range} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE n NB1 g SHIA c SFT saliency -0.1
    } -cleanup {
        cleanup
    } -result {
        saliency {invalid value "-0.1", should be a real number in range 0.0, 1.0, or one of: CR, VI, I, LI, UN, NG}
    }


    test UPDATE-1.8 {invalid atrend} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE n NB1 g SHIA c SFT atrend -1.0
    } -cleanup {
        cleanup
    } -result {
        atrend {invalid value "-1.0", expected double no less than 0.0}
    }

    test UPDATE-1.9 {invalid athresh} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE n NB1 g SHIA c SFT athresh NONESUCH
    } -cleanup {
        cleanup
    } -result {
        athresh {invalid value "NONESUCH", should be a real number in range -100.0, 100.0, or one of: VS, S, A, D, VD}
    }

    test UPDATE-1.10 {invalid dtrend} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE n NB1 g SHIA c SFT dtrend 1.0
    } -cleanup {
        cleanup
    } -result {
        dtrend {invalid value "1.0", expected double no greater than 0.0}
    }

    test UPDATE-1.11 {invalid dthresh} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE n NB1 g SHIA c SFT dthresh NONESUCH
    } -cleanup {
        cleanup
    } -result {
        dthresh {invalid value "NONESUCH", should be a real number in range -100.0, 100.0, or one of: VS, S, A, D, VD}
    }

    test UPDATE-2.1 {sat is updated} -setup {
        setup
    } -body {
        ted order SAT:UPDATE {
            n              NB1
            g              SHIA
            c              SFT
            sat0           VS
            saliency       VI
            atrend         2
            athresh        -5
            dtrend         -1
            dthresh        10
        }
        ted query {
            SELECT * FROM sat_ngc
        }
    } -cleanup {
        cleanup
    } -result {
n   g    c   sat0 saliency atrend athresh dtrend dthresh 
--- ---- --- ---- -------- ------ ------- ------ ------- 
NB1 SHIA AUT 0.0  1.0      0.0    0.0     0.0    0.0     
NB1 SHIA CUL 0.0  1.0      0.0    0.0     0.0    0.0     
NB1 SHIA QOL 0.0  1.0      0.0    0.0     0.0    0.0     
NB1 SHIA SFT 80.0 0.85     2.0    -5.0    -1.0   10.0    
    }


    test UPDATE-2.2 {<Entity> update} -setup {
        setup
    } -body {
        ted notifier bind ::sat <Entity>
        ted order SAT:UPDATE n NB1 g SHIA c SFT sat0 4.0
        ted notifier received
    } -cleanup {
        cleanup
    } -result {
        {::sat <Entity> update {NB1 SHIA SFT}}
    }


    test UPDATE-3.1 {undo undoes the change} -setup {
        setup

        ted order SAT:UPDATE {
            n              NB1
            g              SHIA
            c              SFT
            sat0           VS
            saliency       VI
            atrend         2
            athresh        -5
            dtrend         -1
            dthresh        10
        }
    } -body {
        ted notifier bind ::sat <Entity>
        cif undo -test
        ted notifier received
    } -cleanup {
        cleanup
    } -result {
        {::sat <Entity> update {NB1 SHIA SFT}}
    }

    #-------------------------------------------------------------------
    # SAT:UPDATE:MULTI

    test UPDATE:MULTI-1.1 {required parms} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI {}
    } -cleanup {
        cleanup
    } -result {
        ids {required value}
    }
    

    test UPDATE:MULTI-1.2 {invalid n in ids} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI \
            ids {{NONESUCH1 SHIA SFT}}
    } -cleanup {
        cleanup
    } -result {
        ids {Invalid neighborhood, should be one of: NB1}
    }


    test UPDATE:MULTI-1.3 {invalid g in ids} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI \
            ids {{NB1 NONESUCH SFT}}
    } -cleanup {
        cleanup
    } -result {
        ids {Invalid satisfaction group, should be one of: SHIA, SUNN}
    }


    test UPDATE:MULTI-1.4 {invalid c in ids} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI \
            ids {{NB1 SHIA NONESUCH}}
    } -cleanup {
        cleanup
    } -result {
        ids {invalid value "NONESUCH", should be one of: AUT, SFT, CUL, QOL, CAS}
    }


    test UPDATE:MULTI-1.5 {undefined curve} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI ids {{NB1 SUNN AUT}}
    } -cleanup {
        cleanup
    } -result {
        ids {Satisfaction is not tracked for group SUNN's AUT in NB1.}
    }


    test UPDATE:MULTI-1.6 {invalid sat0: symbol} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI \
            ids {{NB1 SHIA SFT}} sat0 NONESUCH
    } -cleanup {
        cleanup
    } -result {
        sat0 {invalid value "NONESUCH", should be a real number in range -100.0, 100.0, or one of: VS, S, A, D, VD}
    }


    test UPDATE:MULTI-1.7 {invalid sat0: out of range} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI ids {{NB1 SHIA SFT}} sat0 101.0
    } -cleanup {
        cleanup
    } -result {
        sat0 {invalid value "101.0", should be a real number in range -100.0, 100.0, or one of: VS, S, A, D, VD}
    }


    test UPDATE:MULTI-1.8 {invalid saliency: symbol} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI \
            ids {{NB1 SHIA SFT}} saliency NONESUCH
    } -cleanup {
        cleanup
    } -result {
        saliency {invalid value "NONESUCH", should be a real number in range 0.0, 1.0, or one of: CR, VI, I, LI, UN, NG}
    }


    test UPDATE:MULTI-1.9 {invalid saliency: out of range} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI ids \
            {{NB1 SHIA SFT}} saliency -0.1
    } -cleanup {
        cleanup
    } -result {
        saliency {invalid value "-0.1", should be a real number in range 0.0, 1.0, or one of: CR, VI, I, LI, UN, NG}
    }


    test UPDATE:MULTI-1.10 {invalid atrend} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI ids {{NB1 SHIA SFT}} atrend -5
    } -cleanup {
        cleanup
    } -result {
        atrend {invalid value "-5", expected double no less than 0.0}
    }

    test UPDATE:MULTI-1.11 {invalid athresh} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI ids {{NB1 SHIA SFT}} athresh NONESUCH
    } -cleanup {
        cleanup
    } -result {
        athresh {invalid value "NONESUCH", should be a real number in range -100.0, 100.0, or one of: VS, S, A, D, VD}
    }

    test UPDATE:MULTI-1.12 {invalid dtrend} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI ids {{NB1 SHIA SFT}} dtrend 5
    } -cleanup {
        cleanup
    } -result {
        dtrend {invalid value "5", expected double no greater than 0.0}
    }

    test UPDATE:MULTI-1.13 {invalid dthresh} -setup {
        setup
    } -body {
        ted order -reject SAT:UPDATE:MULTI ids {{NB1 SHIA SFT}} dthresh NONESUCH
    } -cleanup {
        cleanup
    } -result {
        dthresh {invalid value "NONESUCH", should be a real number in range -100.0, 100.0, or one of: VS, S, A, D, VD}
    }

    test UPDATE:MULTI-2.1 {one curve of several is updated} -setup {
        setup
    } -body {
        ted notifier bind ::sat <Entity>

        ted order SAT:UPDATE:MULTI {
            ids       {{NB1 SHIA SFT}}
            sat0      VS
            saliency  VI
            atrend    2
            athresh   -5
            dtrend    -1
            dthresh   10
        }

        ted notifier received
    } -cleanup {
        cleanup
    } -result {
        {::sat <Entity> update {NB1 SHIA SFT}}
    }


    test UPDATE:MULTI-2.2 {several curves are updated} -setup {
        setup
    } -body {
        ted notifier bind ::sat <Entity>
        ted order SAT:UPDATE:MULTI {
            ids   {{NB1 SHIA SFT} {NB1 SHIA CUL}} 
            sat0  4.0
        }
        ted notifier received
    } -cleanup {
        cleanup
    } -result {
        {::sat <Entity> update {NB1 SHIA SFT}}
        {::sat <Entity> update {NB1 SHIA CUL}}
    }


    test UPDATE:MULTI-3.1 {undo undoes the change} -setup {
        setup

        ted order SAT:UPDATE:MULTI {
            ids        {{NB1 SHIA SFT} {NB1 SHIA CUL}}
            sat0       VS
            saliency   VI
            atrend     2
            athresh    -5
            dtrend     -1
            dthresh    10
        }
    } -body {
        ted notifier bind ::sat <Entity>
        cif undo -test
        ted notifier received
    } -cleanup {
        cleanup
    } -result {
        {::sat <Entity> update {NB1 SHIA SFT}}
        {::sat <Entity> update {NB1 SHIA CUL}}
    }


    #-------------------------------------------------------------------
    # Cleanup

    cleanupTests
}

namespace delete ::athena_test::tests::






